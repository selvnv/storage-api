name: Simple Workflow
on:
 push:
  branches:
    - 'main'
    - 'dev'

jobs:

  build:
    runs-on: ubuntu-latest
    steps:
    - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
    # –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
    - uses: actions/checkout@v4
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python
    - uses: actions/setup-python@v4
      with:
        python-version: '3.13'

    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    - name: install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install uv
        uv sync

    - name: check_code
      run: |
        uv run ruff check && echo -e "\e[32m–õ–∏–Ω—Ç–µ—Ä –Ω–µ –≤—ã—è–≤–∏–ª –æ—à–∏–±–æ–∫\e[0m"

    # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
    - name: make migrations
      run: |
        uv run python manage.py makemigrations
        uv run python manage.py makemigrations api
        uv run python manage.py migrate

    # –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ "&"
    # until ...; do ...; done - bash —Ü–∏–∫–ª
    # –û–Ω –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –ø–æ–∫–∞ –∫–æ–º–∞–Ω–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–Ω—É–ª–µ–≤–æ–π –∫–æ–¥ (—Ç–æ –µ—Å—Ç—å –æ—à–∏–±–∫—É).
    - name: run server
      run: |
        uv run python manage.py runserver &
        until curl -s http://127.0.0.1:8000/; do sleep 1; done

    # –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
    - name: test api
      run: |
        curl -X GET http://127.0.0.1:8000/user/ || echo -e "\033[0;31m –û—à–∏–±–∫–∞: /user/ \033[0m"
        curl -X GET http://127.0.0.1:8000/user_role/ || echo -e "\033[0;31m –û—à–∏–±–∫–∞: /user/ \033[0m"